
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard - ProInvest</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white p-6 shadow rounded">
    <h2 class="text-2xl font-bold mb-6 text-center">Welcome to Your Dashboard</h2>

    <!-- Live Deposit History -->
    <div>
      <h3 class="font-semibold mb-2">Your Deposits (Live)</h3>
      <table class="w-full border-collapse border border-gray-200 mb-6">
        <thead>
          <tr class="bg-gray-100">
            <th class="border px-4 py-2 text-left">Amount</th>
            <th class="border px-4 py-2 text-left">Method</th>
            <th class="border px-4 py-2 text-left">Date</th><th class="border px-4 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="depositTable">
          <tr><td colspan="3" class="text-center p-4 text-gray-500">Loading...</td></tr>
        </tbody>
      </table>
    
    <!-- Live Withdrawal History -->
    
    <!-- Export Buttons -->
    <div class="flex gap-4 mb-6">
      <button onclick="exportTableToCSV('depositTable', 'my-deposits.csv')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Export Deposits</button>
      <button onclick="exportTableToCSV('withdrawalTable', 'my-withdrawals.csv')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">Export Withdrawals</button>
    </div>
    <div class="mt-10">
      <h3 class="font-semibold mb-2">Your Withdrawals (Live)</h3>
      <table class="w-full border-collapse border border-gray-200">
        <thead>
          <tr class="bg-gray-100">
            <th class="border px-4 py-2 text-left">Amount</th>
            <th class="border px-4 py-2 text-left">Method</th>
            <th class="border px-4 py-2 text-left">Date</th><th class="border px-4 py-2 text-left">Status</th>
          </tr>
        </thead>
        <tbody id="withdrawalTable">
          <tr><td colspan="3" class="text-center p-4 text-gray-500">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    </div>
    

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const depositTable = document.getElementById("depositTable");
const withdrawalTable = document.getElementById("withdrawalTable");

    onAuthStateChanged(auth, (user) => {
      if (user) {
        const wq = query(
          collection(db, "withdrawals"),
          where("userId", "==", user.uid),
          orderBy("timestamp", "desc")
        );
        onSnapshot(wq, (snapshot) => {
          withdrawalTable.innerHTML = "";
          if (snapshot.empty) {
            withdrawalTable.innerHTML = "<tr><td colspan='3' class='text-center p-4 text-gray-500'>No withdrawals found.</td></tr>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.timestamp.toDate().toLocaleString();
            withdrawalTable.innerHTML += `
              <tr>
                <td class="border px-4 py-2">$${data.amount}</td>
                <td class="border px-4 py-2">${data.method}</td>
                <td class="border px-4 py-2">${date}</td><td class="border px-4 py-2">${data.status || 'pending'}</td>
              </tr>
            `;
          });
        });
      if (user) {
        const q = query(
          collection(db, "deposits"),
          where("userId", "==", user.uid),
          orderBy("timestamp", "desc")
        );

        onSnapshot(q, (snapshot) => {
          depositTable.innerHTML = "";
          if (snapshot.empty) {
            depositTable.innerHTML = "<tr><td colspan='3' class='text-center p-4 text-gray-500'>No deposits found.</td></tr>";
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.timestamp.toDate().toLocaleString();
            depositTable.innerHTML += `
              <tr>
                <td class="border px-4 py-2">$${data.amount}</td>
                <td class="border px-4 py-2">${data.method}</td>
                <td class="border px-4 py-2">${date}</td><td class="border px-4 py-2">${data.status || 'pending'}</td>
              </tr>
            `;
          });
        });
      } else {
        window.location.href = "login.html";
      }
    });
  
function exportTableToCSV(tableId, filename) {
  const table = document.getElementById(tableId);
  const rows = Array.from(table.querySelectorAll("tr"));
  const csv = rows.map(row =>
    Array.from(row.querySelectorAll("th, td"))
      .map(cell => \`"\${cell.innerText}"\`)
      .join(",")
  ).join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", filename);
  link.click();
}

</script>
</body>
</html>
